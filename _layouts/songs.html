<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

  {%- include head.html -%}
  <head>
    <style>
      div.part {
      display: flex;
      flex-direction: column;
      float  : left;
      justify-content: flex-end;
      margin : .3em;
      /* border: 1px solid red; */
    }
    div.chord {
        text-align  : left;
        font-weight : bolder;
        font-style  : italic;
        /* margin : .3em; */
        /* border: 1px solid green; */
    }
    div.lyric {
        text-align  : left;
        /* margin : .3em; */
        /* border: 1px solid blue; */
    }

    div.lyrics-line {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
        justify-content: flex-start;
        margin : .3em;
        /* border: 1px solid goldenrod; */
    }

    div.songs {
        display: inline-flex;
        justify-content: flex-start;
        flex-wrap: nowrap;
        flex-direction: column;
        /* margin : .3em; */
        /* border: 1px solid cyan; */
    }
    </style>
  </head>
  <body>

    {%- include header.html -%}

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="post-content e-content" itemprop="articleBody"
          style="display: none;">
          {{ content }}
        </div>

        <div class="video">
          <iframe src="{{ page.youtube }}" frameborder="0"
            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>
        </div>

        <h2>{{ page.name }}</h2>
        <p>Artist: {{ page.artist }}</p>
        <p>Tuning: {{ page.tuning }}</p>

        <div class="songs" id="songs">
          <!-- The lyrics will be populated by the JavaScript function -->
        </div>
      </div>
    </main>

    {%- include footer.html -%}

    <script>
      function renderLyrics(line) {
          let parts = line.split(/(\[[^\]]+\])/).filter(Boolean); // Split parts and filter out empty strings

          let lyricsLineDiv = document.createElement('div');
          lyricsLineDiv.className = 'lyrics-line';

          for (let i = 0; i < parts.length; i++) {
              if (parts[i].startsWith('[')) {
                  // Chord
                  let chord = parts[i].substring(1, parts[i].length - 1); // Remove []

                  // Lyrics part should follow the chord (if exists)
                  let lyrics = '';
                  if (i + 1 < parts.length) {
                      lyrics = parts[i + 1].trim(); // Trim whitespace
                      i++; // Move to the next part (lyrics)
                  }

                  // Create part div
                  let partDiv = document.createElement('div');
                  partDiv.className = 'part';

                  // Create chord div
                  let chordDiv = document.createElement('div');
                  chordDiv.className = 'chord';
                  chordDiv.textContent = chord;
                  partDiv.appendChild(chordDiv);

                  // Create lyric div and append
                  let lyricDiv = document.createElement('div');
                  lyricDiv.className = 'lyric';
                  lyricDiv.textContent = lyrics;
                  partDiv.appendChild(lyricDiv);

                  // Append part div to lyricsLineDiv
                  lyricsLineDiv.appendChild(partDiv);
              } else {
                  // No chord specified, treat entire part as lyrics
                  let lyrics = parts[i].trim();

                  // Create part div
                  let partDiv = document.createElement('div');
                  partDiv.className = 'part';

                  // Create empty chord div
                  // let chordDiv = document.createElement('div');
                  // chordDiv.className = 'chord';
                  // chordDiv.textContent = '\u00A0'; // Use &nbsp; for empty chord
                  // partDiv.appendChild(chordDiv);

                  // Create lyric div and append
                  let lyricDiv = document.createElement('div');
                  lyricDiv.className = 'lyric';
                  lyricDiv.textContent = lyrics;
                  partDiv.appendChild(lyricDiv);

                  // Append part div to lyricsLineDiv
                  lyricsLineDiv.appendChild(partDiv);
              }
          }

          return lyricsLineDiv;
      }

      function renderSong(input) {
          let lines = input.split('\n').map(line => line.trim()).filter(line => line !== ''); // Split by lines, trim whitespace, and filter out empty lines

          let songsDiv = document.getElementById('songs');
          songsDiv.innerHTML = ''; // Clear any existing content

          lines.forEach(line => {
              let lyricsLineDiv = renderLyrics(line);
              songsDiv.appendChild(lyricsLineDiv);
          });
      }

      function htmlEntityDecode(html) {
          var txt = document.createElement('textarea');
          txt.innerHTML = html;
          return txt.value;
      }

      function stripPTagsAndBrTags(html) {
          return html.replace(/<\/?p>/g, '').replace(/<br\s*\/?>/g, '');
      }
      document.addEventListener('DOMContentLoaded', function() {
          const rawContent = document.querySelector('.post-content').innerHTML.trim();
          const decodedContent = htmlEntityDecode(rawContent);
          const strippedContent = stripPTagsAndBrTags(decodedContent);
          console.log(strippedContent);
          renderSong(strippedContent);
      });
    </script>

  </body>
</html>
